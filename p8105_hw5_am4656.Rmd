---
title: "p8105_hw5_am4656"
author: "Aaron Mittel"
date: "2022-11-11"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
```

# Problem 1
In this problem, we create a dataframe containing data from participants in the downloaded "data" folder. Each participant's data is saved in a separate file within this folder, which can be mapped in iterative fashion using the read_csv function.
```{r creating study data dataframe from files in data folder, message = FALSE, include = TRUE, echo = FALSE}
file_names =
list.files(path = "./data") %>% 
  str_replace("con","data/con") %>% 
  str_replace("exp","data/exp") %>% 
  as_tibble()

study_data = map_dfr(file_names, read_csv) %>% 
  mutate(
    id = row_number(),
    arm = ifelse(id < 11, "control","experimental"),
  ) %>% 
  relocate(id,arm) %>% 
  pivot_longer(
    week_1:week_8,
    values_to = "value",
    names_to = "week") %>% 
  mutate(
    week = (str_replace(week, "week_","")),
    week = as.numeric(week)) %>% 
  group_by(week)

study_data %>% 
  ggplot(aes(x = week, y = value, color = factor(id))) +
  geom_line() + geom_point() +
  facet_grid(~arm) +
  viridis::scale_color_viridis(discrete = TRUE)
```

In general, patients in the experimental group have values that increase over time. Patients in the control group have values that remain relatively stable over time.

# Problem 2
```{r creating homicide dataframe, message = FALSE, include = FALSE}
homicide_data = 
  read_csv("./homicide-data.csv") %>% 
  janitor::clean_names() %>% 
  mutate(
    city_state = str_c(city, ", ", state))
```

This dataframe contains 12 columns which report location, assigned case id ('uid'), date of homicide,  victim demographics, and case outcome (`disposition`) of homicides from the decade preceding 2018. There are `r nrow(homicide_data)` rows and `r homicide_data %>% select(city) %>% distinct %>% nrow` distinct cities.

```{r creating homicide_data dataframe focusing on solved vs unsolved homicides, include = FALSE, message = FALSE}
homicide_data_solved =
  homicide_data %>%
  group_by(city_state, disposition) %>% 
  filter(
    disposition == "Closed by arrest" | disposition == "Open/No arrest" | disposition == "Closed without arrest") %>% 
  summarize(
    number = n()) %>% 
  pivot_wider(
    names_from = disposition,
    values_from = number
  ) %>% 
  rowwise() %>% 
  mutate(
    unsolved = sum(c_across("Closed without arrest":"Open/No arrest")),
    total = sum(c_across("Closed by arrest":"Open/No arrest")),
    proportion_unsolved = unsolved/total)
```

## Estimating the Proportion of Unsolved Homicides in Baltimore, MD
```{r baltimore focused solved vs unsolved dataframe, include = TRUE, echo = FALSE, message = FALSE}
homicide_data_solved_baltimore =
homicide_data_solved %>% 
  filter(
    city_state == "Baltimore, MD")

prop.test(x = homicide_data_solved_baltimore %>% pull(unsolved), n = homicide_data_solved_baltimore %>% pull(total), alternative = c("two.sided"), conf.level = 0.95) %>% 
  broom::tidy() %>% 
  select(estimate, conf.low, conf.high) %>% 
  knitr::kable(digits = 2, caption = "Table 1. Estimate and 95% CI for proportion of murders that are unsolved in Baltimore, MD")
```

```{r all city focused estimates of unsolved homicides, include = TRUE, echo = FALSE, message = FALSE}
prop.test.homicide = function(df) {
  prop.test(x = df %>% pull(unsolved), n = df %>% pull(total), alternative = c("two.sided"), conf.level = 0.95)
}

homicide_data_solved_nest =
  nest(homicide_data_solved, data = "Closed by arrest":"proportion_unsolved")

prop.test.homicide(homicide_data_solved_nest$data[[3]])

map(homicide_data_solved_nest$data, prop.test.homicide)
```

